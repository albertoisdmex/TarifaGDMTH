<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Comparativa Tarifa CFE GDMTH</title>
    <style>
        body {
            font-family: 'Inter', sans-serif; margin: 0; padding: 1rem; background-color: #91b3d6;
            color: #1f2937; display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }
        .main-container { display: flex; flex-wrap: wrap; gap: 2rem; width: 100%; max-width: 1200px; margin-bottom: 2rem; }
        .column {
            background-color: #ffffff; padding: 1.5rem; border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            flex: 1; min-width: 300px; box-sizing: border-box;
        }
        .column h3 { color: #111827; text-align: center; margin-top: 0; margin-bottom: 1.5rem; font-size: 1.25rem; font-weight: 600; }
        h1, h2 { color: #111827; text-align: center; margin-bottom: 0.5rem; width: 100%; max-width: 1200px; }
        h1 { font-size: 1.875rem; font-weight: 600; margin-top: 1rem; }
        h2 { font-size: 1.25rem; font-weight: 500; margin-bottom: 1.5rem; }
        .input-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; margin-bottom: 1.5rem; }
        .input-group label { display: block; margin-bottom: 0.5rem; color: #4b5563; font-weight: 500; }
        .input-group input, .input-group select {
            width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem;
            box-sizing: border-box; transition: border-color 0.3s;
        }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); }
        .button-container { width: 100%; display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem; }
        button {
            background-color: #10b981; color: white; padding: 0.75rem 1.5rem; border: none;
            border-radius: 0.375rem; cursor: pointer; font-size: 1rem; font-weight: 500;
            display: block; width: 100%; transition: background-color 0.3s; flex: 1;
        }
        button:hover { background-color: #059669; }
        .button-save { background-color: #3b82f6; } .button-save:hover { background-color: #2563eb; }
        .button-load { background-color: #8b5cf6; } .button-load:hover { background-color: #7c3aed; }
        .button-delete { background-color: #ef4444; } .button-delete:hover { background-color: #dc2626; }
        .button-reset { background-color: #6b7280; } .button-reset:hover { background-color: #4b5563; }
        .results { margin-top: 1.5rem; padding: 1rem; background-color: #f9fafb; border-radius: 0.375rem; border: 1px solid #e5e7eb; }
        .results h4 { margin-top: 0; color: #111827; font-size: 1.125rem; font-weight: 500; margin-bottom: 1rem; }
        .results p { margin: 0.5rem 0; color: #374151; }
        .results strong { color: #1d4ed8; }
        .results .calculated-demand { font-style: italic; color: #555; font-size: 0.9em; }
        .total-emphasis { font-size: 1.125rem; font-weight: 600; }
        .info-section { width: 100%; max-width: 1200px; margin-bottom: 1rem; }
        .disclaimer, .source-info, .chart-container {
            font-size: 0.875rem; color: #6b7280; text-align: justify; padding: 1.5rem;
            background-color: #ffffff; border-radius: 0.75rem;
            border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 1rem;
        }
        .disclaimer ul { padding-left: 1.25rem; list-style-type: disc; }
        .disclaimer li { margin-bottom: 0.5rem; }
        .source-info h4, .chart-container h4 {
            color: #111827; font-weight: 600; font-size: 1.25rem; margin-top: 0; margin-bottom: 1rem; text-align: center;
        }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.875rem; }
        th, td { border: 1px solid #e5e7eb; padding: 0.75rem; text-align: left; vertical-align: middle; }
        th { background-color: #f3f4f6; font-weight: 500; }
        td input[type="number"], td input[type="text"], td select {
            width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; box-sizing: border-box;
        }
        td input[type="number"] { text-align: right; }
        .chart-wrapper { display: flex; flex-wrap: wrap; gap: 2rem; justify-content: center; }
        .chart-box { flex: 1; min-width: 300px; max-width: 400px; }
        .chart-box h5 { text-align: center; font-size: 1.1rem; color: #374151; margin-bottom: 1rem; }
        #storageStatus {
            text-align: center; padding: 0.5rem; border-radius: 0.375rem; margin-bottom: 1rem; font-weight: 500; display: none;
        }
        .status-load { background-color: #e0e7ff; color: #4338ca; }
        .status-save { background-color: #d1fae5; color: #065f46; }
        .status-error { background-color: #fee2e2; color: #991b1b; }
        .gestion-tarifas-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; align-items: end; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        @media (min-width: 500px) { .input-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); } }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <img src="ISDmex_logo.png" alt="ISDmex Logo" style="height: 40px;">
    <h1>Calculadora Comparativa de Costo Eléctrico</h1>
    <h2>Tarifa CFE GDMTH (Demandas Calculadas)</h2>
    
    <div class="main-container">
        <div class="column">
            <h3>Datos Actuales</h3>
            <div class="input-grid">
                 <div class="input-group"><label for="energiaBaseActual">Consumo Energía Base (kWh):</label><input type="number" id="energiaBaseActual" value="1000" step="any"></div>
                <div class="input-group"><label for="energiaIntermediaActual">Consumo Energía Intermedia (kWh):</label><input type="number" id="energiaIntermediaActual" value="1000" step="any"></div>
                <div class="input-group"><label for="energiaPuntaActual">Consumo Energía Punta (kWh):</label><input type="number" id="energiaPuntaActual" value="500" step="any"></div>
                <div class="input-group"><label for="kvarhActual">Energía Reactiva (kVArh):</label><input type="number" id="kvarhActual" value="800" step="any"></div>
                <div class="input-group"><label for="potenciaKwPuntaActual">Potencia kW Punta (Capacidad):</label><input type="number" id="potenciaKwPuntaActual" value="90" step="any"></div>
                <div class="input-group"><label for="potenciaKwMaxActual">Potencia kW Máxima (Distribución):</label><input type="number" id="potenciaKwMaxActual" value="180" step="any"></div>
                <div class="input-group"><label for="diasFacturacionActual">Días de Facturación:</label><input type="number" id="diasFacturacionActual" value="30" step="1"></div>
            </div>
            <div id="resultsActual" class="results" style="display:none;">
                 <h4>Resultados (Actual):</h4>
                <p class="calculated-demand">Demanda Capacidad (Calculada): <span id="demandaCalculadaCapacidadValActual"></span> kW</p>
                <p class="calculated-demand">Demanda Distribución (Calculada): <span id="demandaCalculadaDistribucionValActual"></span> kW</p>
                <p class="calculated-demand">Factor de Potencia: <span id="factorPotenciaActual"></span>%</p>
                <hr style="margin: 0.5rem 0;">
                <p>Costo Transmisión: $<span id="costoTransmisionActual"></span></p>
                <p>Costo CENACE: $<span id="costoCenaceActual"></span></p>
                <p>Costo SCnMEM: $<span id="costoScnmemActual"></span></p>
                <p>Costo Componente Energía Base: $<span id="costoEnergiaBaseActual"></span></p>
                <p>Costo Componente Energía Intermedia: $<span id="costoEnergiaIntermediaActual"></span></p>
                <p>Costo Componente Energía Punta: $<span id="costoEnergiaPuntaActual"></span></p>
                <p>Costo Distribución: $<span id="costoDistribucionActual"></span></p>
                <p>Costo Capacidad: $<span id="costoCapacidadActual"></span></p>
                <p id="fpCargoActual" style="display:none;">Cargo por Factor de Potencia: $<span id="cargoFPActual"></span></p>
                <p id="fpBoniActual" style="display:none;">Bonificación por Factor de Potencia: $<span id="boniFPActual"></span></p>
                <hr style="margin: 1rem 0;">
                <p>Cargo Fijo Mensual: $<span id="cargoFijoActual"></span></p>
                <p><strong>Subtotal antes de IVA: $<span id="subtotalAntesIvaActual"></span></strong></p>
                <p>IVA (16%): $<span id="ivaActual"></span></p>
                <p class="total-emphasis"><strong>TOTAL MENSUAL (ACTUAL): $<span id="totalAproximadoActual"></span></strong></p>
            </div>
        </div>

        <div class="column">
            <h3>Datos con Gestión / Recomendados</h3>
            <div class="input-grid">
                <div class="input-group"><label for="energiaBaseRecomendada">Consumo Energía Base (kWh):</label><input type="number" id="energiaBaseRecomendada" value="800" step="any"></div>
                <div class="input-group"><label for="energiaIntermediaRecomendada">Consumo Energía Intermedia (kWh):</label><input type="number" id="energiaIntermediaRecomendada" value="700" step="any"></div>
                <div class="input-group"><label for="energiaPuntaRecomendada">Consumo Energía Punta (kWh):</label><input type="number" id="energiaPuntaRecomendada" value="200" step="any"></div>
                <div class="input-group"><label for="kvarhRecomendada">Energía Reactiva (kVArh):</label><input type="number" id="kvarhRecomendada" value="800" step="any"></div>
                <div class="input-group"><label for="potenciaKwPuntaRecomendada">Potencia kW Punta (Capacidad):</label><input type="number" id="potenciaKwPuntaRecomendada" value="70" step="any"></div>
                <div class="input-group"><label for="potenciaKwMaxRecomendada">Potencia kW Máxima (Distribución):</label><input type="number" id="potenciaKwMaxRecomendada" value="150" step="any"></div>
                <div class="input-group"><label for="diasFacturacionRecomendada">Días de Facturación:</label><input type="number" id="diasFacturacionRecomendada" value="30" step="1"></div>
            </div>
            <div id="resultsRecomendada" class="results" style="display:none;">
                <h4>Resultados (Con Gestión):</h4>
                <p class="calculated-demand">Demanda Capacidad (Calculada): <span id="demandaCalculadaCapacidadValRecomendada"></span> kW</p>
                <p class="calculated-demand">Demanda Distribución (Calculada): <span id="demandaCalculadaDistribucionValRecomendada"></span> kW</p>
                <p class="calculated-demand">Factor de Potencia: <span id="factorPotenciaRecomendada"></span>%</p>
                <hr style="margin: 0.5rem 0;">
                <p>Costo Transmisión: $<span id="costoTransmisionRecomendada"></span></p>
                <p>Costo CENACE: $<span id="costoCenaceRecomendada"></span></p>
                <p>Costo SCnMEM: $<span id="costoScnmemRecomendada"></span></p>
                <p>Costo Componente Energía Base: $<span id="costoEnergiaBaseRecomendada"></span></p>
                <p>Costo Componente Energía Intermedia: $<span id="costoEnergiaIntermediaRecomendada"></span></p>
                <p>Costo Componente Energía Punta: $<span id="costoEnergiaPuntaRecomendada"></span></p>
                <p>Costo Distribución: $<span id="costoDistribucionRecomendada"></span></p>
                <p>Costo Capacidad: $<span id="costoCapacidadRecomendada"></span></p>
                <p id="fpCargoRecomendada" style="display:none;">Cargo por Factor de Potencia: $<span id="cargoFPRecomendada"></span></p>
                <p id="fpBoniRecomendada" style="display:none;">Bonificación por Factor de Potencia: $<span id="boniFPRecomendada"></span></p>
                <hr style="margin: 1rem 0;">
                <p>Cargo Fijo Mensual: $<span id="cargoFijoRecomendada"></span></p>
                <p><strong>Subtotal antes de IVA: $<span id="subtotalAntesIvaRecomendada"></span></strong></p>
                <p>IVA (16%): $<span id="ivaRecomendada"></span></p>
                <p class="total-emphasis"><strong>TOTAL MENSUAL (CON GESTIÓN): $<span id="totalAproximadoRecomendada"></span></strong></p>
            </div>
        </div>
    </div>

    <div class="info-section" style="max-width: 700px;">
        <button onclick="calcularAmbosEscenarios()">Calcular Costos y Comparación</button>
    </div>

    <div class="info-section" id="ahorroSection" style="display:none;">
        <div id="ahorroEstimado" class="results" style="margin-bottom: 1rem; background-color: #e0f2fe; border-color: #7dd3fc;">
             <h4 style="color: #0c4a6e; text-align:center;">Ahorro Estimado con Gestión</h4>
             <p style="font-size: 1.2rem; font-weight: 500; text-align:center;">Diferencia Total Mensual: <span id="diferenciaTotal" style="color: #059669; font-weight:bold;"></span></p>
             <p style="font-size: 1.2rem; font-weight: 500; text-align:center;">Porcentaje de Ahorro: <span id="porcentajeAhorro" style="color: #059669; font-weight:bold;"></span>%</p>
        </div>
    </div>

    <div class="info-section">
        <div id="graficosContainer" class="chart-container" style="display:none;">
            <h4>Comparación Gráfica de Componentes del Costo (Agrupado)</h4>
            <div class="chart-wrapper">
                <div class="chart-box"><h5>Costo Actual</h5><canvas id="graficoActual"></canvas></div>
                <div class="chart-box"><h5>Costo con Gestión</h5><canvas id="graficoGestion"></canvas></div>
            </div>
        </div>
    </div>
    
    <div class="info-section">
        <div class="source-info">
            <h4>Gestión de Perfiles de Tarifas</h4>
            <div id="storageStatus"></div>
            
            <div class="gestion-tarifas-grid" style="margin-bottom: 1rem;">
                <div>
                    <label for="selectTarifasGuardadas">Cargar Perfil Guardado:</label>
                    <select id="selectTarifasGuardadas">
                        <option value="">-- No hay perfiles guardados --</option>
                    </select>
                </div>
                 <div>
                    <label for="inputNombreTarifa">Nombre del Perfil a Guardar:</label>
                    <input type="text" id="inputNombreTarifa" placeholder="Ej: Oficina Enero 2025">
                </div>
            </div>
             <div class="button-container" style="margin-bottom: 1.5rem;">
    <button onclick="cargarTarifaSeleccionada()" class="button-load">Cargar</button>
    <button onclick="guardarTarifaActual()" class="button-save">Guardar</button>
    <button onclick="eliminarTarifaSeleccionada()" class="button-delete">Eliminar</button>
    <button onclick="restablecerTarifasDefault()" class="button-reset">Por Defecto</button>
    <!-- Botones nuevos -->
    <button onclick="exportarPerfiles()" class="button-save">Exportar Perfiles</button>
    <button onclick="document.getElementById('importarInput').click()" class="button-load">Importar Perfiles</button>
    <input type="file" id="importarInput" accept=".json" style="display: none;" onchange="importarPerfiles(this)">
</div>

            <table style="margin-bottom: 1.5rem;">
                <thead><tr><th colspan="4">Contexto de la Tarifa</th></tr></thead>
                <tbody>
                     <tr>
                        <td><label for="inputAnio">Año</label></td><td><input type="number" id="inputAnio" placeholder="Ej: 2025"></td>
                        <td><label for="inputMes">Mes</label></td>
                        <td>
                            <select id="inputMes">
                                <option value="Enero">Enero</option><option value="Febrero">Febrero</option><option value="Marzo">Marzo</option><option value="Abril">Abril</option><option value="Mayo">Mayo</option><option value="Junio">Junio</option><option value="Julio">Julio</option><option value="Agosto">Agosto</option><option value="Septiembre">Septiembre</option><option value="Octubre">Octubre</option><option value="Noviembre">Noviembre</option><option value="Diciembre">Diciembre</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td><label for="inputEstado">Estado</label></td><td><input type="text" id="inputEstado" placeholder="Ej: Ciudad de México"></td>
                        <td><label for="inputMunicipio">Municipio</label></td><td><input type="text" id="inputMunicipio" placeholder="Ej: Venustiano Carranza"></td>
                    </tr>
                     <tr>
                        <td><label for="inputDivision">División CFE</label></td><td colspan="3"><input type="text" id="inputDivision" placeholder="Ej: Valle de México Centro"></td>
                    </tr>
                </tbody>
            </table>
            
            <table>
                <thead><tr><th>Componente Tarifario</th><th>Valor (MXN)</th><th>Unidad</th></tr></thead>
                <tbody>
                    <tr><td>Componente Transmisión</td><td><input type="number" id="inputTransComun" step="any"></td><td>$/kWh</td></tr>
                    <tr><td>Componente CENACE</td><td><input type="number" id="inputCenaceComun" step="any"></td><td>$/kWh</td></tr>
                    <tr><td>Componente SCnMEM</td><td><input type="number" id="inputScnmemComun" step="any"></td><td>$/kWh</td></tr>
                    <tr><td>Componente Específico Energía Base</td><td><input type="number" id="inputEnergiaBaseComp" step="any"></td><td>$/kWh</td></tr>
                    <tr><td>Componente Específico Energía Intermedia</td><td><input type="number" id="inputEnergiaInterComp" step="any"></td><td>$/kWh</td></tr>
                    <tr><td>Componente Específico Energía Punta</td><td><input type="number" id="inputEnergiaPuntaComp" step="any"></td><td>$/kWh</td></tr>
                    <tr><td>Precio Distribución</td><td><input type="number" id="inputDistribucion" step="any"></td><td>$/kW-mes</td></tr>
                    <tr><td>Precio Capacidad</td><td><input type="number" id="inputCapacidad" step="any"></td><td>$/kW-mes</td></tr>
                    <tr><td>Cargo Fijo Mensual</td><td><input type="number" id="inputCargoFijo" step="any"></td><td>$/mes</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
<script>
    let chartActual = null;
    let chartGestion = null;
    const IVA_TASA = 0.16;
    const STORAGE_KEY = 'listaPerfilesTarifasGDMTH';
    const perfilDefault = {
        nombre: 'Tarifa CFE Defecto (Marzo 2025)',
        anio: 2025, mes: 'Marzo', estado: 'Ciudad de México', municipio: 'Venustiano Carranza', division: 'Valle de México Centro',
        transmision: 0.1809, cenace: 0.0065, scnmem: 0.0062, energiaBaseComp: 0.8798, energiaInterComp: 1.6814,
        energiaPuntaComp: 1.9113, distribucion: 147.44, capacidad: 371.46, cargoFijo: 401.12
    };

    function mostrarEstado(mensaje, tipo) {
        const statusEl = document.getElementById('storageStatus');
        statusEl.textContent = mensaje;
        statusEl.className = `status-${tipo}`;
        statusEl.style.display = 'block';
        setTimeout(() => { statusEl.style.display = 'none'; }, 4000);
    }
    
    function popularFormulario(perfil) {
        document.getElementById('inputNombreTarifa').value = perfil.nombre || '';
        document.getElementById('inputAnio').value = perfil.anio || '';
        document.getElementById('inputMes').value = perfil.mes || 'Enero';
        document.getElementById('inputEstado').value = perfil.estado || '';
        document.getElementById('inputMunicipio').value = perfil.municipio || '';
        document.getElementById('inputDivision').value = perfil.division || '';
        document.getElementById('inputTransComun').value = (perfil.transmision || 0).toFixed(4);
        document.getElementById('inputCenaceComun').value = (perfil.cenace || 0).toFixed(4);
        document.getElementById('inputScnmemComun').value = (perfil.scnmem || 0).toFixed(4);
        document.getElementById('inputEnergiaBaseComp').value = (perfil.energiaBaseComp || 0).toFixed(4);
        document.getElementById('inputEnergiaInterComp').value = (perfil.energiaInterComp || 0).toFixed(4);
        document.getElementById('inputEnergiaPuntaComp').value = (perfil.energiaPuntaComp || 0).toFixed(4);
        document.getElementById('inputDistribucion').value = (perfil.distribucion || 0).toFixed(2);
        document.getElementById('inputCapacidad').value = (perfil.capacidad || 0).toFixed(2);
        document.getElementById('inputCargoFijo').value = (perfil.cargoFijo || 0).toFixed(2);
    }

    function leerPerfilesDeStorage() {
        const perfiles = localStorage.getItem(STORAGE_KEY);
        return perfiles ? JSON.parse(perfiles) : [];
    }

    function actualizarDropdownPerfiles() {
        const perfiles = leerPerfilesDeStorage();
        const selectEl = document.getElementById('selectTarifasGuardadas');
        selectEl.innerHTML = ''; 
        if (perfiles.length === 0) {
            selectEl.innerHTML = '<option value="">-- No hay perfiles guardados --</option>';
            return;
        }
        perfiles.forEach((perfil, index) => {
            const option = new Option(perfil.nombre, index);
            selectEl.add(option);
        });
    }
    
    function cargarTarifaSeleccionada() {
        const perfiles = leerPerfilesDeStorage();
        const selectedIndex = document.getElementById('selectTarifasGuardadas').value;
        if (selectedIndex === '' || !perfiles[selectedIndex]) {
            mostrarEstado('Por favor, selecciona un perfil válido para cargar.', 'error');
            return;
        }
        popularFormulario(perfiles[selectedIndex]);
        mostrarEstado(`Perfil "${perfiles[selectedIndex].nombre}" cargado.`, 'load');
    }

    function guardarTarifaActual() {
        const nombrePerfil = document.getElementById('inputNombreTarifa').value.trim();
        if (!nombrePerfil) {
            mostrarEstado('Por favor, introduce un nombre para guardar el perfil.', 'error');
            return;
        }
        let perfiles = leerPerfilesDeStorage();
        const existingIndex = perfiles.findIndex(p => p.nombre === nombrePerfil);

        if (existingIndex !== -1) {
            if (!confirm(`Ya existe un perfil con el nombre "${nombrePerfil}". ¿Deseas sobreescribirlo?`)) {
                return;
            }
        }
        
        const nuevoPerfil = {
            nombre: nombrePerfil,
            anio: document.getElementById('inputAnio').value, mes: document.getElementById('inputMes').value,
            estado: document.getElementById('inputEstado').value, municipio: document.getElementById('inputMunicipio').value,
            division: document.getElementById('inputDivision').value,
            transmision: parseFloat(document.getElementById('inputTransComun').value) || 0,
            cenace: parseFloat(document.getElementById('inputCenaceComun').value) || 0,
            scnmem: parseFloat(document.getElementById('inputScnmemComun').value) || 0,
            energiaBaseComp: parseFloat(document.getElementById('inputEnergiaBaseComp').value) || 0,
            energiaInterComp: parseFloat(document.getElementById('inputEnergiaInterComp').value) || 0,
            energiaPuntaComp: parseFloat(document.getElementById('inputEnergiaPuntaComp').value) || 0,
            distribucion: parseFloat(document.getElementById('inputDistribucion').value) || 0,
            capacidad: parseFloat(document.getElementById('inputCapacidad').value) || 0,
            cargoFijo: parseFloat(document.getElementById('inputCargoFijo').value) || 0
        };

        if (existingIndex !== -1) {
            perfiles[existingIndex] = nuevoPerfil;
        } else {
            perfiles.push(nuevoPerfil);
        }
        
        localStorage.setItem(STORAGE_KEY, JSON.stringify(perfiles));
        actualizarDropdownPerfiles();
        mostrarEstado(`Perfil "${nombrePerfil}" guardado exitosamente.`, 'save');
    }

    function eliminarTarifaSeleccionada() {
        const perfiles = leerPerfilesDeStorage();
        const selectEl = document.getElementById('selectTarifasGuardadas');
        const selectedIndex = selectEl.value;
        if (selectedIndex === '' || !perfiles[selectedIndex]) {
            mostrarEstado('Por favor, selecciona un perfil válido para eliminar.', 'error');
            return;
        }

        const nombrePerfilEliminado = perfiles[selectedIndex].nombre;
        if (confirm(`¿Estás seguro de que quieres eliminar el perfil "${nombrePerfilEliminado}"?`)) {
            perfiles.splice(selectedIndex, 1);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(perfiles));
            actualizarDropdownPerfiles();
            mostrarEstado(`Perfil "${nombrePerfilEliminado}" eliminado.`, 'save');
        }
    }

    function restablecerTarifasDefault() {
        popularFormulario(perfilDefault);
        mostrarEstado('Se han restablecido las tarifas por defecto.', 'load');
    }
    // Función para exportar perfiles a un archivo JSON
function exportarPerfiles() {
    const perfiles = leerPerfilesDeStorage();
    if (perfiles.length === 0) {
        mostrarEstado('No hay perfiles para exportar.', 'error');
        return;
    }

    const datos = {
        fechaExportacion: new Date().toISOString(),
        version: '1.0',
        perfiles: perfiles
    };

    const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `PerfilesTarifasCFE_${new Date().toLocaleDateString('es-MX')}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    mostrarEstado(`Perfiles exportados correctamente (${perfiles.length} perfiles).`, 'save');
}

// Función para importar perfiles desde un archivo JSON
function importarPerfiles(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const datos = JSON.parse(e.target.result);
            if (!datos.perfiles || !Array.isArray(datos.perfiles)) {
                throw new Error('Formato de archivo inválido');
            }

            let perfilesActuales = leerPerfilesDeStorage();
            const nuevosNombres = datos.perfiles.map(p => p.nombre);
            const existentes = perfilesActuales.filter(p => nuevosNombres.includes(p.nombre));

            if (existentes.length > 0) {
                if (!confirm(`Advertencia: ${existentes.length} perfiles ya existen. ¿Deseas sobrescribirlos?`)) {
                    return;
                }
                // Eliminar los existentes para evitar duplicados
                const nombresExistentes = existentes.map(p => p.nombre);
                perfilesActuales = perfilesActuales.filter(p => !nombresExistentes.includes(p.nombre));
            }

            const todosPerfiles = [...perfilesActuales, ...datos.perfiles];
            localStorage.setItem(STORAGE_KEY, JSON.stringify(todosPerfiles));
            actualizarDropdownPerfiles();
            mostrarEstado(`Perfiles importados correctamente (${datos.perfiles.length} nuevos).`, 'save');
        } catch (error) {
            mostrarEstado(`Error al importar: ${error.message}`, 'error');
            console.error(error);
        }
        input.value = ''; // Resetear el input
    };
    reader.readAsText(file);
}
    document.addEventListener('DOMContentLoaded', () => {
        restablecerTarifasDefault();
        actualizarDropdownPerfiles();
    });

    function leerValoresTarifaDelForm() {
        return {
            transmision: parseFloat(document.getElementById('inputTransComun').value) || 0,
            cenace: parseFloat(document.getElementById('inputCenaceComun').value) || 0,
            scnmem: parseFloat(document.getElementById('inputScnmemComun').value) || 0,
            energiaBaseComp: parseFloat(document.getElementById('inputEnergiaBaseComp').value) || 0,
            energiaInterComp: parseFloat(document.getElementById('inputEnergiaInterComp').value) || 0,
            energiaPuntaComp: parseFloat(document.getElementById('inputEnergiaPuntaComp').value) || 0,
            distribucion: parseFloat(document.getElementById('inputDistribucion').value) || 0,
            capacidad: parseFloat(document.getElementById('inputCapacidad').value) || 0,
            cargoFijo: parseFloat(document.getElementById('inputCargoFijo').value) || 0
        };
    }

    function calcularFactorPotencia(kvarh, sumaConsumosKWh) {
        if (sumaConsumosKWh === 0) return 100;
        const fp = Math.cos(Math.atan(kvarh / sumaConsumosKWh)) * 100;
        return Math.min(100, Math.max(0, fp)); // Asegurar que esté entre 0% y 100%
    }

    function calcularCargoBonificacionFP(fp, consumoBase, consumoIntermedia, consumoPunta, precioBase, precioIntermedia, precioPunta, cargoFijo) {
        let cargoFP = 0;
        let boniFP = 0;
        
        // Calculamos la suma ponderada de los consumos por sus precios
        const sumaConsumosPonderada = (consumoBase * precioBase) + 
                                     (consumoIntermedia * precioIntermedia) + 
                                     (consumoPunta * precioPunta);
        
        if (fp > 90) {
            const porceFPalto = (1 - 90 / fp) / 4;
            boniFP = (cargoFijo + sumaConsumosPonderada) * 1.02 * porceFPalto;
        } else if (fp < 90) {
            const porceFPbajo = (3/5) * (90 / fp - 1);
            cargoFP = (cargoFijo + sumaConsumosPonderada) * porceFPbajo;
        }
        
        return { cargoFP, boniFP };
    }

    function realizarCalculo(sufijoId) {
        const tarifas = leerValoresTarifaDelForm();
        const consumoBase = parseFloat(document.getElementById('energiaBase' + sufijoId).value) || 0;
        const consumoIntermedia = parseFloat(document.getElementById('energiaIntermedia' + sufijoId).value) || 0;
        const consumoPunta = parseFloat(document.getElementById('energiaPunta' + sufijoId).value) || 0;
        const kvarh = parseFloat(document.getElementById('kvarh' + sufijoId).value) || 0;
        const potenciaKwPunta = parseFloat(document.getElementById('potenciaKwPunta' + sufijoId).value) || 0;
        const potenciaKwMax = parseFloat(document.getElementById('potenciaKwMax' + sufijoId).value) || 0;
        const diasFacturacion = parseFloat(document.getElementById('diasFacturacion' + sufijoId).value) || 30;

        const sumaConsumosKWh = consumoBase + consumoIntermedia + consumoPunta;
        let demandaCalculadaPorConsumo = (diasFacturacion > 0) ? sumaConsumosKWh / (24 * diasFacturacion * 0.57) : 0;
        
        const demandaFacturableCapacidad = Math.min(potenciaKwPunta, demandaCalculadaPorConsumo);
        const demandaFacturableDistribucion = Math.min(potenciaKwMax, demandaCalculadaPorConsumo);

        // Calcular factor de potencia
        const fp = calcularFactorPotencia(kvarh, sumaConsumosKWh);
        const { cargoFP, boniFP } = calcularCargoBonificacionFP(
            fp, 
            consumoBase, 
            consumoIntermedia, 
            consumoPunta, 
            tarifas.energiaBaseComp, 
            tarifas.energiaInterComp, 
            tarifas.energiaPuntaComp, 
            tarifas.cargoFijo
        );

        const costoTransmision = sumaConsumosKWh * tarifas.transmision;
        const costoCenace = sumaConsumosKWh * tarifas.cenace;
        const costoScnmem = sumaConsumosKWh * tarifas.scnmem;
        const costoEBase = consumoBase * tarifas.energiaBaseComp;
        const costoEIntermedia = consumoIntermedia * tarifas.energiaInterComp;
        const costoEPunta = consumoPunta * tarifas.energiaPuntaComp;
        const costoDist = demandaFacturableDistribucion * tarifas.distribucion;
        const costoCap = demandaFacturableCapacidad * tarifas.capacidad;
        const cargoFijo = tarifas.cargoFijo;

        const subtotalAntesIva = costoTransmision + costoCenace + costoScnmem + costoEBase + costoEIntermedia + costoEPunta + costoDist + costoCap + cargoFijo + cargoFP - boniFP;
        const ivaCalculado = subtotalAntesIva * IVA_TASA;
        const totalAproximado = subtotalAntesIva + ivaCalculado;

        // Mostrar resultados
        document.getElementById('demandaCalculadaCapacidadVal' + sufijoId).textContent = demandaFacturableCapacidad.toFixed(2);
        document.getElementById('demandaCalculadaDistribucionVal' + sufijoId).textContent = demandaFacturableDistribucion.toFixed(2);
        document.getElementById('factorPotencia' + sufijoId).textContent = fp.toFixed(2);
        
        document.getElementById('costoTransmision' + sufijoId).textContent = costoTransmision.toFixed(2);
        document.getElementById('costoCenace' + sufijoId).textContent = costoCenace.toFixed(2);
        document.getElementById('costoScnmem' + sufijoId).textContent = costoScnmem.toFixed(2);
        document.getElementById('costoEnergiaBase' + sufijoId).textContent = costoEBase.toFixed(2);
        document.getElementById('costoEnergiaIntermedia' + sufijoId).textContent = costoEIntermedia.toFixed(2);
        document.getElementById('costoEnergiaPunta' + sufijoId).textContent = costoEPunta.toFixed(2);
        document.getElementById('costoDistribucion' + sufijoId).textContent = costoDist.toFixed(2);
        document.getElementById('costoCapacidad' + sufijoId).textContent = costoCap.toFixed(2);
        document.getElementById('cargoFijo' + sufijoId).textContent = cargoFijo.toFixed(2);
        
        // Mostrar cargo o bonificación según corresponda
        const fpCargoEl = document.getElementById('fpCargo' + sufijoId);
        const fpBoniEl = document.getElementById('fpBoni' + sufijoId);
        const cargoFPEl = document.getElementById('cargoFP' + sufijoId);
        const boniFPEl = document.getElementById('boniFP' + sufijoId);
        
        if (cargoFP > 0) {
            fpCargoEl.style.display = 'block';
            fpBoniEl.style.display = 'none';
            cargoFPEl.textContent = cargoFP.toFixed(2);
        } else if (boniFP > 0) {
            fpCargoEl.style.display = 'none';
            fpBoniEl.style.display = 'block';
            boniFPEl.textContent = boniFP.toFixed(2);
        } else {
            fpCargoEl.style.display = 'none';
            fpBoniEl.style.display = 'none';
        }
        
        document.getElementById('subtotalAntesIva' + sufijoId).textContent = subtotalAntesIva.toFixed(2);
        document.getElementById('iva' + sufijoId).textContent = ivaCalculado.toFixed(2);
        document.getElementById('totalAproximado' + sufijoId).textContent = totalAproximado.toFixed(2);
        
        document.getElementById('results' + sufijoId).style.display = 'block';
        return { 
            total: totalAproximado, 
            costosGrafico: { 
                base: costoEBase, 
                intermedia: costoEIntermedia, 
                punta: costoEPunta, 
                distribucion: costoDist, 
                capacidad: costoCap, 
                fijo: cargoFijo, 
                transmision: costoTransmision, 
                cenace: costoCenace, 
                scnmem: costoScnmem,
                cargoFP: cargoFP,
                boniFP: boniFP
            } 
        };
    }

    function calcularAmbosEscenarios() {
        const resultadoActual = realizarCalculo('Actual');
        const resultadoRecomendado = realizarCalculo('Recomendada');
        if (!resultadoActual || !resultadoRecomendado) return;
        const diferencia = resultadoActual.total - resultadoRecomendado.total;
        const porcentajeAhorro = (resultadoActual.total > 0) ? (diferencia / resultadoActual.total) * 100 : 0;
        document.getElementById('diferenciaTotal').textContent = `$${diferencia.toFixed(2)}`;
        document.getElementById('porcentajeAhorro').textContent = `${porcentajeAhorro.toFixed(2)}`;
        document.getElementById('ahorroSection').style.display = 'block';
        actualizarGraficos(resultadoActual.costosGrafico, resultadoRecomendado.costosGrafico);
        document.getElementById('graficosContainer').style.display = 'block';
    }
    
    function actualizarGraficos(costosActual, costosGestion) {
        const labels = ['Energía (Total)', 'Distribución', 'Capacidad', 'Cargo Fijo', 'FP (Cargo/Boni)'];
        const colors = ['#34d399', '#60a5fa', '#a78bfa', '#9ca3af', '#f59e0b'];
        
        const agruparCostosEnergia = (costos) => [
            costos.base + costos.intermedia + costos.punta + costos.transmision + costos.cenace + costos.scnmem,
            costos.distribucion,
            costos.capacidad,
            costos.fijo,
            Math.max(costos.cargoFP, costos.boniFP) // Mostrar el mayor entre cargo o bonificación
        ];

        const dataActual = { labels: labels, datasets: [{ label: 'Costo Actual', data: agruparCostosEnergia(costosActual), backgroundColor: colors, hoverOffset: 4 }] };
        const dataGestion = { labels: labels, datasets: [{ label: 'Costo con Gestión', data: agruparCostosEnergia(costosGestion), backgroundColor: colors, hoverOffset: 4 }] };

        const config = {
            type: 'doughnut',
            options: { responsive: true, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (c) => `${c.label}: ${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(c.parsed)}` } } } },
        };

        if(chartActual) chartActual.destroy();
        if(chartGestion) chartGestion.destroy();
        chartActual = new Chart(document.getElementById('graficoActual'), { ...config, data: dataActual });
        chartGestion = new Chart(document.getElementById('graficoGestion'), { ...config, data: dataGestion });
    }
</script>
<p>Programa con fines demostrativos y para uso exclusivo de personal de ISDmex. Derechos Reservados. 2025</p>
</body>
</html>